
# Note: Instructions for building/installing Slurm available at
# http://slurm.schedmd.com/quickstart_admin.html.

---
build:
  _: |
    set -euo pipefail

    # Build MUNGE.
    MUNGE_SOURCE='https://github.com/dun/munge/archive/munge-0.5.12.zip'
    MUNGE_PATH="${cw_ROOT}/opt/munge"
    rm -rf "${MUNGE_PATH}" # Get rid of any old version of MUNGE so not building on top of.
    yum install -y openssl-devel
    curl -L "${MUNGE_SOURCE}" -o /tmp/munge.zip
    unzip /tmp/munge.zip
    cd munge-munge-*
    ./configure \
      --prefix="${MUNGE_PATH}" \
      --sysconfdir="${MUNGE_PATH}/etc" \
      --localstatedir="${MUNGE_PATH}/var"
    make
    make install

    # Build Slurm.
    SLURM_SOURCE='https://github.com/SchedMD/slurm/archive/slurm-16-05-0-1.zip'
    SLURM_PATH="${cw_ROOT}/opt/slurm"
    curl -L "${SLURM_SOURCE}" -o /tmp/slurm.zip
    unzip /tmp/slurm.zip
    cd slurm-slurm-*
    ./configure \
      --prefix="${SLURM_PATH}" \
      --with-munge="${MUNGE_PATH}"
    make
    make install

install:
  _: |
    set -euo pipefail

    # Download built Slurm and MUNGE.
    . "${cw_ROOT}/etc/serviceware.rc"
    . "${cw_ROOT}/etc/distro.rc"
    curl -# -L "${cw_DIST_URL}/${cw_DIST}"/munge.tar.gz | tar -C "${cw_ROOT}" -xz
    curl -# -L "${cw_DIST_URL}/${cw_DIST}"/slurm.tar.gz | tar -C "${cw_ROOT}" -xz

    MUNGE_PATH="${cw_ROOT}/opt/munge"
    SLURM_PATH="${cw_ROOT}/opt/slurm"

    # Create MUNGE user and group.
    MUNGE_USER='munge'
    getent group munge &>/dev/null || groupadd --gid 401 "${MUNGE_USER}"
    getent passwd munge &>/dev/null || useradd --uid 401 --gid 401 \
        --shell /sbin/nologin --home-dir "${MUNGE_PATH}" "${MUNGE_USER}"

    # Create MUNGE key - this must be the same on all nodes so create by
    # hashing the cluster secret (which is the same on all nodes).
    MUNGE_KEY_DIR="${MUNGE_PATH}/etc/munge"
    MUNGE_KEY="${MUNGE_KEY_DIR}/munge.key"
    source "${cw_ROOT}/etc/config/cluster/auth.rc"
    echo -n "${cw_CLUSTER_auth_token}" | sha512sum | cut -d' ' -f1 > "${MUNGE_KEY}"
    chmod 400 "${MUNGE_KEY}"

    # MUNGE user needs to own these dirs.
    chown -R "${MUNGE_USER}":"${MUNGE_USER}" "${MUNGE_KEY_DIR}" "${MUNGE_PATH}/var"

    # Create Slurm user and group.
    SLURM_USER='slurm'
    getent group "${SLURM_USER}" &>/dev/null || groupadd --gid 400 "${SLURM_USER}"
    getent passwd "${SLURM_USER}" &>/dev/null || useradd --uid 400 --gid 400 \
        --shell /sbin/nologin --home-dir "${SLURM_PATH}" "${SLURM_USER}"

    # Copy Slurm config.
    mkdir -p "${SLURM_PATH}/etc"
    cp slurm.conf.template "${SLURM_PATH}/etc/slurm.conf"

    # Create needed system dirs owned by Slurm user.
    SLURM_SYSTEM_DIRS=(/var/{log,spool}/slurm)
    mkdir -p ${SLURM_SYSTEM_DIRS[@]}
    chown -R "${SLURM_USER}":"${SLURM_USER}" ${SLURM_SYSTEM_DIRS[@]}

    # Install environment module (we also add it to the skeleton modules file
    # so it will be automatically loaded for Clusterware users created after
    # installing Slurm).
    mkdir -p "${cw_ROOT}"/etc/modules/services
    sed -e "s,_cw_ROOT_,${cw_ROOT},g" slurm-module.template > "${cw_ROOT}"/etc/modules/services/slurm
    sed -e 's,^module load \(.*\),module load services/slurm \1,g' -i "${cw_ROOT}"/etc/skel/modules

component-slurmctld:
  el7: |
    enable_munged() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/systemd/clusterware-munge-munged.service \
            > /etc/systemd/system/clusterware-munge-munged.service
        systemctl enable clusterware-munge-munged.service
    }
    enable_slurmctld() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/systemd/clusterware-slurm-slurmctld.service \
            > /etc/systemd/system/clusterware-slurm-slurmctld.service
        systemctl enable clusterware-slurm-slurmctld.service
    }

    start_slurmctld() {
        systemctl start clusterware-slurm-slurmctld.service
    }

    restart_slurmctld() {
        systemctl restart clusterware-slurm-slurmctld.service
    }
  _: |
    set -euo pipefail

    enable_munged
    enable_slurmctld
    start_slurmctld

component-slurmd:
  el7: |
    enable_munged() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/systemd/clusterware-munge-munged.service \
            > /etc/systemd/system/clusterware-munge-munged.service
        systemctl enable clusterware-munge-munged.service
    }
    enable_slurmd() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/systemd/clusterware-slurm-slurmd.service \
            > /etc/systemd/system/clusterware-slurm-slurmd.service
        systemctl enable clusterware-slurm-slurmd.service
    }

    start_slurmd() {
        systemctl start clusterware-slurm-slurmd.service
    }

    restart_slurmd() {
        systemctl restart clusterware-slurm-slurmd.service
    }
  _: |
    set -euo pipefail

    enable_munged
    enable_slurmd
    start_slurmd
