---
install:
  _: |
    . "${cw_ROOT}"/etc/serviceware.rc
    . "${cw_ROOT}"/etc/distro.rc
    curl -# -L "${cw_DIST_URL}/${cw_DIST}"/alces-websocket-proxy.tar.gz | tar -C "${cw_ROOT}" -xz
component-base:
  el6: |
    enable_alces_websocket_proxy() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/sysv/clusterware-alces-websocket-proxy.el6 \
            > /etc/init.d/clusterware-alces-websocket-proxy
        chmod 755 /etc/init.d/clusterware-alces-websocket-proxy
        chkconfig clusterware-alces-websocket-proxy on
    }
  el7: |
    enable_alces_websocket_proxy() {
        sed -e "s,_cw_ROOT_,${cw_ROOT},g" \
            init/systemd/clusterware-alces-websocket-proxy.service \
            > /etc/systemd/system/clusterware-alces-websocket-proxy.service
        systemctl enable clusterware-alces-websocket-proxy.service
    }
  _: |
    mkdir -p /var/log/alces-websocket-proxy "${cw_ROOT}"/etc/ssl
    chmod 750 /var/log/alces-websocket-proxy
    cp etc/logrotate.d/* "${cw_ROOT}"/etc/logrotate.d
    cp -p etc/ssl/* "${cw_ROOT}"/etc/ssl
    chmod 0600 "${cw_ROOT}"/etc/ssl/*_key.pem
    enable_alces_websocket_proxy
build:
  el6: |
    yum install -y -e0 pcre-devel openssl-devel
  el7: |
    yum install -y -e0 pcre-devel openssl-devel
  _: |
    curl "http://nginx.org/download/nginx-1.6.2.tar.gz" -o /tmp/nginx.tar.gz
    tar -C /tmp -xzf /tmp/nginx.tar.gz
    pushd /tmp/nginx-1.6.2
    DESTDIR="${cw_ROOT}/opt/alces-websocket-proxy"
    ./configure \
      --prefix=$DESTDIR/etc/nginx \
      --conf-path=$DESTDIR/etc/nginx.conf \
      --sbin-path=$DESTDIR/bin/nginx \
      --pid-path=/var/run/alces-websocket-proxy.pid \
      --lock-path=/var/run/lock/alces-websocket-proxy.lock \
      --user=nobody \
      --group=nobody \
      --http-log-path=/var/log/alces-websocket-proxy/access.log \
      --error-log-path=stderr \
      --http-client-body-temp-path=$DESTDIR/var/lib/client-body \
      --http-proxy-temp-path=$DESTDIR/var/lib/proxy \
      --http-fastcgi-temp-path=$DESTDIR/var/lib/fastcgi \
      --http-scgi-temp-path=$DESTDIR/var/lib/scgi \
      --http-uwsgi-temp-path=$DESTDIR/var/lib/uwsgi \
      --with-imap \
      --with-imap_ssl_module \
      --with-ipv6 \
      --with-pcre-jit \
      --with-file-aio \
      --with-http_dav_module \
      --with-http_gunzip_module \
      --with-http_gzip_static_module \
      --with-http_realip_module \
      --with-http_spdy_module \
      --with-http_ssl_module \
      --with-http_stub_status_module \
      --with-http_addition_module \
      --with-http_degradation_module \
      --with-http_flv_module \
      --with-http_mp4_module \
      --with-http_secure_link_module \
      --with-http_sub_module
    make
    make install

    rm "$DESTDIR"/etc/*.default
    install -dm700 "$DESTDIR"/etc/conf.d
    install -d "$DESTDIR"/man/man8/
    gzip -9c man/nginx.8 > "$DESTDIR"/man/man8/nginx.8.gz
    install -d "$DESTDIR"/var/lib
    install -dm700 "$DESTDIR"/var/lib/proxy

    popd
    install -Dm644 nginx.conf.tpl "$DESTDIR"/etc/nginx.conf
    install -Dm644 proxy.conf.tpl "$DESTDIR"/etc/conf.d/proxy.conf
    sed -e "s,_ROOT_,${cw_ROOT},g" -i "$DESTDIR"/etc/nginx.conf "$DESTDIR"/etc/conf.d/proxy.conf
